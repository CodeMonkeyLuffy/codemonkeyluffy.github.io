<!DOCTYPE html>
<html lang=zh-CN>
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="description" content="">
  <meta name="keywords" content="">
  
    <link rel="icon" href="">
  
    
  <title>深度挖掘 Laravel 生命周期 | 路飞的博客</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="/lib/jquery.fancybox.min.css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>
  <header>
  <div class="header-container">
    <a class='logo' href="/">
      <span>路飞的博客</span>
    </a>
    <ul class="right-header">
      
        <li class="nav-item">
          
            <a href="/" class="item-link">首页</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/archives" class="item-link">归档</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/about" class="item-link">关于</a>
          
        </li>
      
    </ul>
  </div>
</header>

  <main id='post'>
  <div class="content">
    <article>
        <section class="content markdown-body">
          <h1>深度挖掘 Laravel 生命周期</h1>
          <div class='post-meta'>
            <i class="fa fa-calendar" aria-hidden="true"></i> <time>2018年05月18日</time>
            
            
              | 
                  <i class="fa fa-tag" aria-hidden="true"></i>
                
               
  <a href="/tags/#laravel" class='tag'>laravel</a>


            
          </div>
          <p>这篇文章我们来聊聊 「Laravel 生命周期」 这个主题。虽然网络上已经有很多关于这个主题的探讨，但这个主题依然值得我们去研究和学习。</p>
<p>我想说的是当我们在决定使用某项技术的时候，除了需要了解它能「做什么」，其实还应当研究它是「怎么做的」。</p>
<p>Laravel 框架或者说任何一个 Web 项目，我们都需要理解它究竟是如何接收到用户发起的 HTTP 请求的；又是如何响应结果给用户的；在处理请求和响应的过程中都存在哪些处理值得深入学习。</p>
<p>所有这些内容其实都包含在 「Laravel 生命周期」 这个主题里面。</p>
<p>本文较长建议使用合适的 IDE 进行代码查阅；或者通过文中的链接，或是代码注释的 「@see」部分直接在 Github 畅读代码。</p>
<h4 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h4><p>Laravel 生命周期（或者说请求生命周期）概括起来主要分为 3 个主要阶段：</p>
<ul>
<li>加载项目依赖</li>
<li>创建 Laravel 应用实例</li>
<li>创建 Laravel 应用实例</li>
</ul>
<p>而这 3 个阶段的处理都发生在入口文件 <a href="https://github.com/laravel/laravel/blob/master/public/index.php" target="_blank" rel="noopener">public/index.php</a> 文件内（<strong>public/index.php</strong> 是一个新安装的 Laravel 项目默认入口文件）。</p>
<p>然而 <strong>index.php</strong> 文件仅包含极少的代码，但却出色的完成了一个 HTTP 请求从接收到响应的全部过程，逻辑组织的几近完美。</p>
<p>我们来看下入口文件实现的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// 阶段一</span><br><span class="line">require __DIR__.&apos;/../vendor/autoload.php&apos;;</span><br><span class="line"></span><br><span class="line">// 阶段二</span><br><span class="line">$app = require_once __DIR__.&apos;/../bootstrap/app.php&apos;;</span><br><span class="line"></span><br><span class="line">// 阶段三</span><br><span class="line">$kernel = $app-&gt;make(Illuminate\Contracts\Http\Kernel::class);</span><br><span class="line"></span><br><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">    $request = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$response-&gt;send();</span><br><span class="line"></span><br><span class="line">// 其它</span><br><span class="line">$kernel-&gt;terminate($request, $response);</span><br></pre></td></tr></table></figure>
<h4 id="生命周期之始末"><a href="#生命周期之始末" class="headerlink" title="生命周期之始末"></a>生命周期之始末</h4><h5 id="加载项目依赖"><a href="#加载项目依赖" class="headerlink" title="加载项目依赖"></a>加载项目依赖</h5><p>现代 PHP 依赖于 Composer 包管理器，入口文件通过引入由 Composer 包管理器自动生成的类加载程序，可以轻松注册并加载项目所依赖的第三方组件库。</p>
<p>所有组件的加载工作，仅需一行代码即可完成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require __DIR__.&apos;/../vendor/autoload.php&apos;;</span><br></pre></td></tr></table></figure>
<h5 id="创建-Laravel-应用实例"><a href="#创建-Laravel-应用实例" class="headerlink" title="创建 Laravel 应用实例"></a>创建 Laravel 应用实例</h5><p>创建应用实例（或称服务容器），由位于 <a href="https://github.com/laravel/laravel/blob/master/bootstrap/app.php" target="_blank" rel="noopener">bootstrap/app.php</a> 文件里的引导程序完成，创建服务容器的过程即为应用初始化的过程，项目初始化时将完成包括：注册项目基础服务、注册项目服务提供者别名、注册目录路径等在内的一些列注册工作。</p>
<p>下面是 <strong>bootstrap/app.php</strong> 的代码，包含两个主要部分「创建应用实例」和「绑定内核至 APP 服务容器」：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// 第一部分： 创建应用实例</span><br><span class="line">$app = new Illuminate\Foundation\Application(</span><br><span class="line">    realpath(__DIR__.&apos;/../&apos;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">// 第二部分： 完成内核绑定</span><br><span class="line">$app-&gt;singleton(</span><br><span class="line">    Illuminate\Contracts\Http\Kernel::class,</span><br><span class="line">    App\Http\Kernel::class</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$app-&gt;singleton(</span><br><span class="line">    Illuminate\Contracts\Console\Kernel::class,</span><br><span class="line">    App\Console\Kernel::class</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$app-&gt;singleton(</span><br><span class="line">    Illuminate\Contracts\Debug\ExceptionHandler::class,</span><br><span class="line">    App\Exceptions\Handler::class</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">return $app;</span><br></pre></td></tr></table></figure>
<h6 id="创建应用实例"><a href="#创建应用实例" class="headerlink" title="创建应用实例"></a>创建应用实例</h6><p>创建应用实例即实例化 <a href="https://github.com/laravel/framework/blob/5.6/src/Illuminate/Foundation/Application.php" target="_blank" rel="noopener">Illuminate\Foundation\Application</a> 这个服务容器，后续我们称其为 <strong>APP 容器</strong>。在创建 APP 容器主要会完成：注册应用的基础路径并将路径绑定到 <strong>APP 容器</strong> 、注册基础服务提供者至 <strong>APP 容器</strong> 、注册核心容器别名至 <strong>APP 容器</strong>等基础服务的注册工作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Create a new Illuminate application instance.</span><br><span class="line"> *</span><br><span class="line"> * @see https://github.com/laravel/framework/blob/5.6/src/Illuminate/Foundation/Application.php#L162:27</span><br><span class="line"> * @param  string|null  $basePath</span><br><span class="line"> * @return void</span><br><span class="line"> */</span><br><span class="line">public function __construct($basePath = null)</span><br><span class="line">&#123;</span><br><span class="line">    if ($basePath) &#123;</span><br><span class="line">        $this-&gt;setBasePath($basePath);</span><br><span class="line">    &#125;</span><br><span class="line">    $this-&gt;registerBaseBindings();</span><br><span class="line">    $this-&gt;registerBaseServiceProviders();</span><br><span class="line">    $this-&gt;registerCoreContainerAliases();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="内核绑定"><a href="#内核绑定" class="headerlink" title="内核绑定"></a>内核绑定</h6><p>接着将关注的焦点转移到绑定内核部分。</p>
<p>Laravel 会依据 HTTP 请求的运行环境的不同，将请求发送至相应的内核： <a href="https://github.com/laravel/laravel/blob/master/app/Http/Kernel.php" target="_blank" rel="noopener">HTTP 内核</a> 或 <a href="https://github.com/laravel/laravel/blob/master/app/Console/Kernel.php" target="_blank" rel="noopener">Console 内核</a>。无论 HTTP 内核还是 Console 内核，它们的作用都是是接收一个 HTTP 请求，随后返回一个响应，就是这么简单。</p>
<p>这篇文章主要研究 HTTP 内核，HTTP 内核继承自 <a href="https://github.com/laravel/framework/blob/5.6/src/Illuminate/Foundation/Http/Kernel.php" target="_blank" rel="noopener">Illuminate\Foundation\Http\Kernel</a> 类.</p>
<p>在 「HTTP 内核」 内它定义了 <a href="(&lt;https://github.com/laravel/laravel/blob/master/app/Http/Kernel.php">中间件</a> 相关数组；在 「Illuminate\Foundation\Http\Kernel」 类内部定义了属性名为 「bootstrappers」 的 <a href="https://github.com/laravel/framework/blob/5.6/src/Illuminate/Foundation/Http/Kernel.php" target="_blank" rel="noopener">引导程序</a> 数组。</p>
<ul>
<li><a href="https://laravel-china.org/docs/laravel/5.6/middleware" target="_blank" rel="noopener">中间件</a> 提供了一种方便的机制来过滤进入应用的 HTTP 请求。</li>
<li>「引导程序」 包括完成环境检测、配置加载、异常处理、Facades 注册、服务提供者注册、启动服务这六个引导程序。</li>
</ul>
<p>至于 「中间件」 和 「引导程序」如何被使用的，会在后面的章节讲解。</p>
<h6 id="注册异常处理"><a href="#注册异常处理" class="headerlink" title="注册异常处理"></a>注册异常处理</h6><p>项目的异常处理由 App\Exceptions\Handler::class 类完成，这边也不做深入的讲解。</p>
<h6 id="本节小结"><a href="#本节小结" class="headerlink" title="本节小结"></a>本节小结</h6><p>通过上面的分析我们可以发现在「创建 Laravel 应用实例」这个阶段它做了很多的基础工作，包括但不限于：创建 APP 容器、注册应用路径、注册基础服务提供者、配置中间件和引导程序等。</p>
<h5 id="接收请求并响应"><a href="#接收请求并响应" class="headerlink" title="接收请求并响应"></a>接收请求并响应</h5><p>在完成创建 APP 容器后即进入了第三个阶段 「接收请求并响应」。</p>
<p>「接收请求并响应」有关代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$kernel = $app-&gt;make(Illuminate\Contracts\Http\Kernel::class);</span><br><span class="line"></span><br><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">    $request = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$response-&gt;send();</span><br></pre></td></tr></table></figure>
<p>我们需要逐行分析上面的代码，才能窥探其中的原貌。</p>
<h6 id="解析内核实例"><a href="#解析内核实例" class="headerlink" title="解析内核实例"></a>解析内核实例</h6><p>在第二阶段我们已经将 <strong>HTTP 内核</strong> 和 <strong>Console 内核</strong> 绑定到了 <strong>APP 容器</strong>，使用时通过 <strong>APP 容器</strong> 的 <strong>make()</strong> 方法将内核解析出来，解析的过程就是内核实例化的过程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$kernel = $app-&gt;make(Illuminate\Contracts\Http\Kernel::class);</span><br></pre></td></tr></table></figure>
<p>内核实例化时它的内部究竟又做了哪些操作呢？</p>
<p>进一步挖掘 <a href="https://github.com/laravel/framework/blob/5.6/src/Illuminate/Foundation/Http/Kernel.php" target="_blank" rel="noopener">Illuminate\Foundation\Http\Kernel</a> 内核的 <strong>__construct(Illuminate\Contracts\Foundation\Application $app, \Illuminate\Routing\Router $router)</strong> 构造方法，它接收 <strong>APP 容器</strong> 和 <strong>路由器</strong> 两个参数。</p>
<p>在实例化内核时，构造函数内将在 HTTP 内核定义的「中间件组」注册到 <a href="https://github.com/laravel/framework/blob/5.6/src/Illuminate/Routing/Router.php" target="_blank" rel="noopener">路由器</a>，注册完后就可以在实际处理 HTTP 请求前调用这些「中间件」实现 <strong>过滤</strong> 请求的目的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    /**</span><br><span class="line">     * Create a new HTTP kernel instance. 创建 HTTP 内核实例</span><br><span class="line">     * </span><br><span class="line">     * @class Illuminate\Foundation\Http\Kernel</span><br><span class="line">     * @param  \Illuminate\Contracts\Foundation\Application  $app</span><br><span class="line">     * @param  \Illuminate\Routing\Router  $router</span><br><span class="line">     * @return void</span><br><span class="line">     */</span><br><span class="line">    public function __construct(Application $app, Router $router)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;app = $app;</span><br><span class="line">        $this-&gt;router = $router;</span><br><span class="line"></span><br><span class="line">        $router-&gt;middlewarePriority = $this-&gt;middlewarePriority;</span><br><span class="line"></span><br><span class="line">        foreach ($this-&gt;middlewareGroups as $key =&gt; $middleware) &#123;</span><br><span class="line">            $router-&gt;middlewareGroup($key, $middleware);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        foreach ($this-&gt;routeMiddleware as $key =&gt; $middleware) &#123;</span><br><span class="line">            $router-&gt;aliasMiddleware($key, $middleware);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    /**</span><br><span class="line">     * Register a group of middleware. 注册中间件组</span><br><span class="line">     *</span><br><span class="line">     * @class \Illuminate\Routing\Router</span><br><span class="line">     * @param  string  $name</span><br><span class="line">     * @param  array  $middleware</span><br><span class="line">     * @return $this</span><br><span class="line">     */</span><br><span class="line">    public function middlewareGroup($name, array $middleware)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;middlewareGroups[$name] = $middleware;</span><br><span class="line"></span><br><span class="line">        return $this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Register a short-hand name for a middleware. 注册中间件别名</span><br><span class="line">     *</span><br><span class="line">     * @class \Illuminate\Routing\Router</span><br><span class="line">     * @param  string  $name</span><br><span class="line">     * @param  string  $class</span><br><span class="line">     * @return $this</span><br><span class="line">     */</span><br><span class="line">    public function aliasMiddleware($name, $class)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;middleware[$name] = $class;</span><br><span class="line"></span><br><span class="line">        return $this;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h6 id="处理-HTTP-请求"><a href="#处理-HTTP-请求" class="headerlink" title="处理 HTTP 请求"></a>处理 HTTP 请求</h6><p>之前的所有处理，基本都是围绕在配置变量、注册服务等运行环境的构建上，构建完成后才是真刀真枪的来处理一个「HTTP 请求」。</p>
<p>处理请求实际包含两个阶段：</p>
<ul>
<li>创建请求实例</li>
<li>处理请求</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 处理请求</span><br><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">    // 创建请求实例</span><br><span class="line">    $request = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>####### 创建请求实例</p>
<p>请求实例 <a href="https://github.com/laravel/framework/blob/5.6/src/Illuminate/Http/Request.php" target="_blank" rel="noopener">Illuminate\Http\Request</a> 的 <strong>capture()</strong> 方法内部通过 Symfony 实例创建一个 Laravel 请求实例。这样我们就可以获取到用户请求报文的相关信息了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">    * Create a new Illuminate HTTP request from server variables.</span><br><span class="line">    * </span><br><span class="line">    * @class Illuminate\Http\Request</span><br><span class="line">    * @return static</span><br><span class="line">    */</span><br><span class="line">   public static function capture()</span><br><span class="line">   &#123;</span><br><span class="line">       static::enableHttpMethodParameterOverride();</span><br><span class="line">       return static::createFromBase(SymfonyRequest::createFromGlobals());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   /**</span><br><span class="line">    * Create an Illuminate request from a Symfony instance.</span><br><span class="line">    *</span><br><span class="line">    * @see https://github.com/symfony/symfony/blob/master/src/Symfony/Component/HttpFoundation/Request.php</span><br><span class="line">    * @param  \Symfony\Component\HttpFoundation\Request  $request</span><br><span class="line">    * @return \Illuminate\Http\Request</span><br><span class="line">    */</span><br><span class="line">   public static function createFromBase(SymfonyRequest $request)</span><br><span class="line">   &#123;</span><br><span class="line">       if ($request instanceof static) &#123;</span><br><span class="line">           return $request;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       $content = $request-&gt;content;</span><br><span class="line"></span><br><span class="line">       $request = (new static)-&gt;duplicate(</span><br><span class="line">           $request-&gt;query-&gt;all(), $request-&gt;request-&gt;all(), $request-&gt;attributes-&gt;all(),</span><br><span class="line">           $request-&gt;cookies-&gt;all(), $request-&gt;files-&gt;all(), $request-&gt;server-&gt;all()</span><br><span class="line">       );</span><br><span class="line"></span><br><span class="line">       $request-&gt;content = $content;</span><br><span class="line"></span><br><span class="line">       $request-&gt;request = $request-&gt;getInputSource();</span><br><span class="line"></span><br><span class="line">       return $request;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h6 id="处理请求"><a href="#处理请求" class="headerlink" title="#处理请求"></a>#处理请求</h6><p>请求处理发生在 <a href="https://github.com/laravel/framework/blob/5.6/src/Illuminate/Foundation/Http/Kernel.php" target="_blank" rel="noopener">HTTP 内核</a> 的 <strong>handle()</strong> 方法内。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Handle an incoming HTTP request.</span><br><span class="line"> *</span><br><span class="line"> * @class Illuminate\Foundation\Http\Kernel</span><br><span class="line"> * @param  \Illuminate\Http\Request  $request</span><br><span class="line"> * @return \Illuminate\Http\Response</span><br><span class="line"> */</span><br><span class="line">public function handle($request)</span><br><span class="line">&#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        $request-&gt;enableHttpMethodParameterOverride();</span><br><span class="line"></span><br><span class="line">        $response = $this-&gt;sendRequestThroughRouter($request);</span><br><span class="line">    &#125; catch (Exception $e) &#123;</span><br><span class="line">        $this-&gt;reportException($e);</span><br><span class="line"></span><br><span class="line">        $response = $this-&gt;renderException($request, $e);</span><br><span class="line">    &#125; catch (Throwable $e) &#123;</span><br><span class="line">        $this-&gt;reportException($e = new FatalThrowableError($e));</span><br><span class="line"></span><br><span class="line">        $response = $this-&gt;renderException($request, $e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $this-&gt;app[&apos;events&apos;]-&gt;dispatch(</span><br><span class="line">        new Events\RequestHandled($request, $response)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    return $response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>handle()</strong> 方法接收一个 HTTP 请求，并最终生成一个 HTTP 响应。</p>
<p>继续深入到处理 HTTP 请求的方法 <strong>$this-&gt;sendRequestThroughRouter($request)</strong> 内部。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Send the given request through the middleware / router.</span><br><span class="line"> *</span><br><span class="line"> * @see https://github.com/laravel/framework/blob/5.6/src/Illuminate/Foundation/Http/Kernel.php</span><br><span class="line"> * @param  \Illuminate\Http\Request  $request</span><br><span class="line"> * @return \Illuminate\Http\Response</span><br><span class="line"> */</span><br><span class="line">protected function sendRequestThroughRouter($request)</span><br><span class="line">&#123;</span><br><span class="line">    $this-&gt;app-&gt;instance(&apos;request&apos;, $request);</span><br><span class="line"></span><br><span class="line">    Facade::clearResolvedInstance(&apos;request&apos;);</span><br><span class="line"></span><br><span class="line">    $this-&gt;bootstrap();</span><br><span class="line"></span><br><span class="line">    return (new Pipeline($this-&gt;app))</span><br><span class="line">                -&gt;send($request)</span><br><span class="line">                -&gt;through($this-&gt;app-&gt;shouldSkipMiddleware() ? [] : $this-&gt;middleware)</span><br><span class="line">                -&gt;then($this-&gt;dispatchToRouter());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将发现这段代码没有一行废话，它完成了大量的逻辑处理：</p>
<ul>
<li>首先，将 $request 实例注册到 <strong>APP 容器</strong> 供后续使用；</li>
<li>之后，清除之前 $request 实例缓存；</li>
<li>然后，启动「引导程序」；</li>
<li>最后，发送请求至路由。</li>
</ul>
<h6 id="启动「引导程序」"><a href="#启动「引导程序」" class="headerlink" title="#启动「引导程序」"></a>#启动「引导程序」</h6><p>记得我们在之前「2.2.2 内核绑定」章节，有介绍在「HTTP 内核」中有把「引导程序(bootstrappers)」绑定到了 <strong>APP 容器</strong>，以及这些引导程序的具体功能。</p>
<p>但是没有聊如何调用这些「引导程序」。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">    * Send the given request through the middleware / router.</span><br><span class="line">    *</span><br><span class="line">    * @see https://github.com/laravel/framework/blob/5.6/src/Illuminate/Foundation/Http/Kernel.php</span><br><span class="line">    * @param  \Illuminate\Http\Request  $request</span><br><span class="line">    * @return \Illuminate\Http\Response</span><br><span class="line">    */</span><br><span class="line">   protected function sendRequestThroughRouter($request)</span><br><span class="line">   &#123;</span><br><span class="line">       ...</span><br><span class="line"></span><br><span class="line">       // 启动 「引导程序」</span><br><span class="line">       $this-&gt;bootstrap();</span><br><span class="line"></span><br><span class="line">       ...</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码块说明在 <strong>$this-&gt;bootstrap();</strong> 方法内部有实际调用「引导程序」，而 <strong>bootstrap()</strong> 实际调用的是 <strong>APP 容器的 bootstrapWith()</strong>,来看看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">... </span><br><span class="line">    /**</span><br><span class="line">     * The bootstrap classes for the application. 应用的引导程序</span><br><span class="line">     *</span><br><span class="line">     * @var array</span><br><span class="line">     */</span><br><span class="line">    protected $bootstrappers = [</span><br><span class="line">        \Illuminate\Foundation\Bootstrap\LoadEnvironmentVariables::class,</span><br><span class="line">        \Illuminate\Foundation\Bootstrap\LoadConfiguration::class,</span><br><span class="line">        \Illuminate\Foundation\Bootstrap\HandleExceptions::class,</span><br><span class="line">        \Illuminate\Foundation\Bootstrap\RegisterFacades::class,</span><br><span class="line">        \Illuminate\Foundation\Bootstrap\RegisterProviders::class,</span><br><span class="line">        \Illuminate\Foundation\Bootstrap\BootProviders::class,</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Bootstrap the application for HTTP requests.</span><br><span class="line">     * </span><br><span class="line">     * @class Illuminate\Foundation\Http\Kernel</span><br><span class="line">     * @return void</span><br><span class="line">     */</span><br><span class="line">    public function bootstrap()</span><br><span class="line">    &#123;</span><br><span class="line">        if (! $this-&gt;app-&gt;hasBeenBootstrapped()) &#123;</span><br><span class="line">            $this-&gt;app-&gt;bootstrapWith($this-&gt;bootstrappers());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected function bootstrappers()</span><br><span class="line">    &#123;</span><br><span class="line">        return $this-&gt;bootstrappers;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>最终还是要看 <a href="https://github.com/laravel/framework/blob/5.6/src/Illuminate/Foundation/Application.php" target="_blank" rel="noopener">Illuminate\Foundation\Application</a> 的 <strong>bootstrapWith()</strong> 方法究竟如何来启动这些引导程序的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">     * Run the given array of bootstrap classes.</span><br><span class="line">     * </span><br><span class="line">     * @class  Illuminate\Foundation\Application APP 容器</span><br><span class="line">     * @param  array  $bootstrappers</span><br><span class="line">     * @return void</span><br><span class="line">     */</span><br><span class="line">    public function bootstrapWith(array $bootstrappers)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;hasBeenBootstrapped = true;</span><br><span class="line"></span><br><span class="line">        foreach ($bootstrappers as $bootstrapper) &#123;</span><br><span class="line">            $this[&apos;events&apos;]-&gt;fire(&apos;bootstrapping: &apos;.$bootstrapper, [$this]);</span><br><span class="line"></span><br><span class="line">            $this-&gt;make($bootstrapper)-&gt;bootstrap($this);</span><br><span class="line"></span><br><span class="line">            $this[&apos;events&apos;]-&gt;fire(&apos;bootstrapped: &apos;.$bootstrapper, [$this]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>我们看到在 APP 容器内，会先解析对应的「引导程序」（即实例化），随后调用「引导程序」的 <strong>bootstrap()</strong> 完成的「引导程序」的启动操作。</p>
<p>作为示例我们随便挑一个「引导程序」来看看其内部的启动原理。</p>
<p>这边我们选 <a href="https://github.com/laravel/framework/blob/5.6/src/Illuminate/Foundation/Bootstrap/LoadConfiguration.php" target="_blank" rel="noopener">Illuminate\Foundation\Bootstrap\LoadConfiguration::class</a>，它的功能是加载配置文件。</p>
<p>还记得我们讲解「2.2 创建 Laravel 应用实例」章节的时候有「注册应用的基础路径并将路径绑定到 <strong>APP 容器</strong>」。此时，<strong>LoadConfiguration</strong> 类就是将 <strong>config</strong> 目录下的所有配置文件读取到一个集合中，这样我们就可以项目里通过 <strong>config()</strong> 辅助函数获取配置数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class LoadConfiguration</span><br><span class="line">&#123;</span><br><span class="line">    /**</span><br><span class="line">     * Bootstrap the given application.</span><br><span class="line">     *</span><br><span class="line">     * @see https://github.com/laravel/framework/blob/5.6/src/Illuminate/Foundation/Bootstrap/LoadConfiguration.php</span><br><span class="line">     * @param  \Illuminate\Contracts\Foundation\Application  $app</span><br><span class="line">     * @return void</span><br><span class="line">     */</span><br><span class="line">    public function bootstrap(Application $app)</span><br><span class="line">    &#123;</span><br><span class="line">        $items = [];</span><br><span class="line"></span><br><span class="line">        if (file_exists($cached = $app-&gt;getCachedConfigPath())) &#123;</span><br><span class="line">            $items = require $cached;</span><br><span class="line">            $loadedFromCache = true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $app-&gt;instance(&apos;config&apos;, $config = new Repository($items));</span><br><span class="line"></span><br><span class="line">        if (! isset($loadedFromCache)) &#123;</span><br><span class="line">            $this-&gt;loadConfigurationFiles($app, $config);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $app-&gt;detectEnvironment(function () use ($config) &#123;</span><br><span class="line">            return $config-&gt;get(&apos;app.env&apos;, &apos;production&apos;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        date_default_timezone_set($config-&gt;get(&apos;app.timezone&apos;, &apos;UTC&apos;));</span><br><span class="line">        mb_internal_encoding(&apos;UTF-8&apos;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Load the configuration items from all of the files.</span><br><span class="line">     *</span><br><span class="line">     * @param  \Illuminate\Contracts\Foundation\Application  $app</span><br><span class="line">     * @param  \Illuminate\Contracts\Config\Repository  $repository</span><br><span class="line">     * @return void</span><br><span class="line">     * @throws \Exception</span><br><span class="line">     */</span><br><span class="line">    protected function loadConfigurationFiles(Application $app, RepositoryContract $repository)</span><br><span class="line">    &#123;</span><br><span class="line">        $files = $this-&gt;getConfigurationFiles($app);</span><br><span class="line"></span><br><span class="line">        if (! isset($files[&apos;app&apos;])) &#123;</span><br><span class="line">            throw new Exception(&apos;Unable to load the &quot;app&quot; configuration file.&apos;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        foreach ($files as $key =&gt; $path) &#123;</span><br><span class="line">            $repository-&gt;set($key, require $path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>所有 「引导程序」列表功能如下：</strong></p>
<ul>
<li><a href="https://github.com/laravel/framework/blob/5.6/src/Illuminate/Foundation/Bootstrap/LoadEnvironmentVariables.php" target="_blank" rel="noopener">Illuminate\Foundation\Bootstrap\LoadEnvironmentVariables</a> : 环境检测，通过 DOTENV 组件将 <strong>.env</strong> 配置文件载入到 <strong>$_ENV</strong> 变量中；</li>
<li><a href="https://github.com/laravel/framework/blob/5.6/src/Illuminate/Foundation/Bootstrap/LoadConfiguration.php" target="_blank" rel="noopener">Illuminate\Foundation\Bootstrap\LoadConfiguration</a> : 加载配置文件，这个我们刚刚分析过；</li>
<li><a href="https://github.com/laravel/framework/blob/5.6/src/Illuminate/Foundation/Bootstrap/HandleExceptions.php" target="_blank" rel="noopener">Illuminate\Foundation\Bootstrap\HandleExceptions</a> ： 异常处理；</li>
<li><a href="https://github.com/laravel/framework/blob/5.6/src/Illuminate/Foundation/Bootstrap/RegisterFacades.php" target="_blank" rel="noopener">Illuminate\Foundation\Bootstrap\RegisterFacades</a> ： 注册 Facades，注册完成后可以以别名的方式访问具体的类；</li>
<li><a href="https://github.com/laravel/framework/blob/5.6/src/Illuminate/Foundation/Bootstrap/RegisterProviders.php" target="_blank" rel="noopener">Illuminate\Foundation\Bootstrap\RegisterProviders</a> : 注册服务提供者，我们在 「2.2.1 创建应用实例」已经将基础服务提供者注册到 <strong>APP 容器</strong>。在这里我们会将配置在 app.php 文件夹下 providers 节点的服务器提供者注册到 APP 容器，供请求处理阶段使用；</li>
<li><a href="https://github.com/laravel/framework/blob/5.6/src/Illuminate/Foundation/Bootstrap/BootProviders.php" target="_blank" rel="noopener">Illuminate\Foundation\Bootstrap\BootProviders</a> : 启动服务</li>
</ul>
<p>####### 发送请求至路由</p>
<p>完成「引导程序」启动操作后，随机进入到请求处理阶段。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Send the given request through the middleware / router.</span><br><span class="line"> *</span><br><span class="line"> * @see https://github.com/laravel/framework/blob/5.6/src/Illuminate/Foundation/Http/Kernel.php</span><br><span class="line"> * @param  \Illuminate\Http\Request  $request</span><br><span class="line"> * @return \Illuminate\Http\Response</span><br><span class="line"> */</span><br><span class="line">protected function sendRequestThroughRouter($request)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    // 发送请求至路由</span><br><span class="line">    return (new Pipeline($this-&gt;app))</span><br><span class="line">                -&gt;send($request)</span><br><span class="line">                -&gt;through($this-&gt;app-&gt;shouldSkipMiddleware() ? [] : $this-&gt;middleware)</span><br><span class="line">                -&gt;then($this-&gt;dispatchToRouter());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 「发送请求至路由」这行代码中，完成了：管道（pipeline）创建、将 $request 传入管道、对 $request 执行「中间件」处理和实际的请求处理四个不同的操作。</p>
<p>在开始前我们需要知道在 Laravel 中有个「中间件」 的概念，即使你还不知道，也没关系，仅需知道它的功能是在处理请求操作之前，对请求进行过滤处理即可，仅当请求符合「中间件」的验证规则时才会继续执行后续处理。</p>
<p>有关 「管道」的相关知识不在本文讲解范围内。</p>
<p>那么，究竟一个请求是如何被处理的呢？</p>
<p>我们来看看 <strong>$this-&gt;dispatchToRouter()</strong> 这句代码，它的方法声明如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">    * Get the route dispatcher callback. 获取一个路由分发器匿名函数</span><br><span class="line">    *</span><br><span class="line">    * @see https://github.com/laravel/framework/blob/5.6/src/Illuminate/Foundation/Http/Kernel.php</span><br><span class="line">    * @return \Closure</span><br><span class="line">    */</span><br><span class="line">   protected function dispatchToRouter()</span><br><span class="line">   &#123;</span><br><span class="line">       return function ($request) &#123;</span><br><span class="line">           $this-&gt;app-&gt;instance(&apos;request&apos;, $request);</span><br><span class="line"></span><br><span class="line">           return $this-&gt;router-&gt;dispatch($request);</span><br><span class="line">       &#125;;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>回顾下「2.3.1 解析内核实例」章节，可知我们已经将 <a href="https://github.com/laravel/framework/blob/5.6/src/Illuminate/Routing/Router.php" target="_blank" rel="noopener">Illuminate\Routing\Router</a>对象赋值给 <strong>$this-&gt;router</strong> 属性。</p>
<p>通过 <strong>router</strong> 实例的 <strong>disptach()</strong> 方法去执行 HTTP 请求，在它的内部会完成如下处理：</p>
<ol>
<li>查找对应的路由实例</li>
<li>通过一个实例栈运行给定的路由</li>
<li>运行在 routes/web.php 配置的匹配到的控制器或匿名函数</li>
<li>返回响应结果</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">//  @see https://github.com/laravel/framework/blob/5.6/src/Illuminate/Routing/Router.php</span><br><span class="line">class Router implements RegistrarContract, BindingRegistrar</span><br><span class="line">&#123;    </span><br><span class="line">    /**</span><br><span class="line">     * Dispatch the request to the application.</span><br><span class="line">     *</span><br><span class="line">     * @param  \Illuminate\Http\Request  $request</span><br><span class="line">     * @return \Illuminate\Http\Response|\Illuminate\Http\JsonResponse</span><br><span class="line">     */</span><br><span class="line">    public function dispatch(Request $request)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;currentRequest = $request;</span><br><span class="line"></span><br><span class="line">        return $this-&gt;dispatchToRoute($request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Dispatch the request to a route and return the response.</span><br><span class="line">     *</span><br><span class="line">     * @param  \Illuminate\Http\Request  $request</span><br><span class="line">     * @return mixed</span><br><span class="line">     */</span><br><span class="line">    public function dispatchToRoute(Request $request)</span><br><span class="line">    &#123;</span><br><span class="line">        return $this-&gt;runRoute($request, $this-&gt;findRoute($request));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Find the route matching a given request. 1. 查找对应的路由实例</span><br><span class="line">     *</span><br><span class="line">     * @param  \Illuminate\Http\Request  $request</span><br><span class="line">     * @return \Illuminate\Routing\Route</span><br><span class="line">     */</span><br><span class="line">    protected function findRoute($request)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;current = $route = $this-&gt;routes-&gt;match($request);</span><br><span class="line"></span><br><span class="line">        $this-&gt;container-&gt;instance(Route::class, $route);</span><br><span class="line"></span><br><span class="line">        return $route;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Return the response for the given route. 2. 通过一个实例栈运行给定的路由</span><br><span class="line">     *</span><br><span class="line">     * @param  Route  $route</span><br><span class="line">     * @param  Request  $request</span><br><span class="line">     * @return mixed</span><br><span class="line">     */</span><br><span class="line">    protected function runRoute(Request $request, Route $route)</span><br><span class="line">    &#123;</span><br><span class="line">        $request-&gt;setRouteResolver(function () use ($route) &#123;</span><br><span class="line">            return $route;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        $this-&gt;events-&gt;dispatch(new Events\RouteMatched($route, $request));</span><br><span class="line"></span><br><span class="line">        return $this-&gt;prepareResponse($request,</span><br><span class="line">            $this-&gt;runRouteWithinStack($route, $request)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Run the given route within a Stack &quot;onion&quot; instance. 通过一个实例栈运行给定的路由</span><br><span class="line">     *</span><br><span class="line">     * @param  \Illuminate\Routing\Route  $route</span><br><span class="line">     * @param  \Illuminate\Http\Request  $request</span><br><span class="line">     * @return mixed</span><br><span class="line">     */</span><br><span class="line">    protected function runRouteWithinStack(Route $route, Request $request)</span><br><span class="line">    &#123;</span><br><span class="line">        $shouldSkipMiddleware = $this-&gt;container-&gt;bound(&apos;middleware.disable&apos;) &amp;&amp;</span><br><span class="line">                                $this-&gt;container-&gt;make(&apos;middleware.disable&apos;) === true;</span><br><span class="line"></span><br><span class="line">        $middleware = $shouldSkipMiddleware ? [] : $this-&gt;gatherRouteMiddleware($route);</span><br><span class="line"></span><br><span class="line">        // 4. 返回响应结果</span><br><span class="line">        return (new Pipeline($this-&gt;container))</span><br><span class="line">                        -&gt;send($request)</span><br><span class="line">                        -&gt;through($middleware)</span><br><span class="line">                        -&gt;then(function ($request) use ($route) &#123;</span><br><span class="line">                            return $this-&gt;prepareResponse(</span><br><span class="line">                                // 3. 运行在 routes/web.php 配置的匹配到的控制器或匿名函数</span><br><span class="line">                                $request, $route-&gt;run()</span><br><span class="line">                            );</span><br><span class="line">                        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>执行 <strong>$route-&gt;run()</strong> 的方法定义在 <a href="https://github.com/laravel/framework/blob/5.6/src/Illuminate/Routing/Route.php" target="_blank" rel="noopener">Illuminate\Routing\Route</a> 类中，最终执行「在 routes/web.php 配置的匹配到的控制器或匿名函数」：</p>
<pre><code>/**
 * Run the route action and return the response.
 * 
 * @see https://github.com/laravel/framework/blob/5.6/src/Illuminate/Routing/Route.php
 * @return mixed
 */
public function run()
{
    $this-&gt;container = $this-&gt;container ?: new Container;

    try {
        if ($this-&gt;isControllerAction()) {
            return $this-&gt;runController();
        }

        return $this-&gt;runCallable();
    } catch (HttpResponseException $e) {
        return $e-&gt;getResponse();
    }
}
</code></pre><p>这部分如果路由的实现是一个控制器，会完成控制器实例化并执行指定方法；如果是一个匿名函数则直接调用这个匿名函数。</p>
<p>其执行结果会通过 <a href="https://github.com/laravel/framework/blob/5.6/src/Illuminate/Routing/Router.php" target="_blank" rel="noopener">Illuminate\Routing\Router::prepareResponse($request, $response)</a> 生一个响应实例并返回。</p>
<p>至此，Laravel 就完成了一个 HTTP 请求的请求处理。</p>
<h5 id="发送响应"><a href="#发送响应" class="headerlink" title="发送响应"></a>发送响应</h5><p>经过一系列漫长的操作，HTTP 请求进入的最终章 - 发送响应值客户端 <strong>$response-&gt;send()</strong>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// @see https://github.com/laravel/laravel/blob/master/public/index.php</span><br><span class="line"></span><br><span class="line">// 阶段一</span><br><span class="line">require __DIR__.&apos;/../vendor/autoload.php&apos;;</span><br><span class="line"></span><br><span class="line">// 阶段二</span><br><span class="line">$app = require_once __DIR__.&apos;/../bootstrap/app.php&apos;;</span><br><span class="line"></span><br><span class="line">// 阶段三</span><br><span class="line">$kernel = $app-&gt;make(Illuminate\Contracts\Http\Kernel::class);</span><br><span class="line"></span><br><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">    $request = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">// 发送响应</span><br><span class="line">$response-&gt;send();</span><br><span class="line"></span><br><span class="line">// 其它</span><br><span class="line">$kernel-&gt;terminate($request, $response);</span><br></pre></td></tr></table></figure>
<p>发送响应由 <a href="https://github.com/laravel/framework/blob/5.6/src/Illuminate/Http/Response.php" target="_blank" rel="noopener">Illuminate\Http\Response</a> 父类<a href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/HttpFoundation/Response.php" target="_blank" rel="noopener">Symfony\Component\HttpFoundation\Response</a> 中的 <strong>send()</strong> 方法完成。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">    * Sends HTTP headers and content.</span><br><span class="line">    * </span><br><span class="line">    * @see https://github.com/symfony/symfony/blob/master/src/Symfony/Component/HttpFoundation/Response.php</span><br><span class="line">    * @return $this</span><br><span class="line">    */</span><br><span class="line">   public function send()</span><br><span class="line">   &#123;</span><br><span class="line">       $this-&gt;sendHeaders();// 发送响应头部信息</span><br><span class="line">       $this-&gt;sendContent();// 发送报文主题</span><br><span class="line"></span><br><span class="line">       if (function_exists(&apos;fastcgi_finish_request&apos;)) &#123;</span><br><span class="line">           fastcgi_finish_request();</span><br><span class="line">       &#125; elseif (!\in_array(PHP_SAPI, array(&apos;cli&apos;, &apos;phpdbg&apos;), true)) &#123;</span><br><span class="line">           static::closeOutputBuffers(0, true);</span><br><span class="line">       &#125;</span><br><span class="line">       return $this;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h5 id="终止程序"><a href="#终止程序" class="headerlink" title="终止程序"></a>终止程序</h5><p>程序终止，完成终止中间件的调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// @see https://github.com/laravel/framework/blob/5.6/src/Illuminate/Foundation/Http/Kernel.php</span><br><span class="line"></span><br><span class="line">public function terminate($request, $response)</span><br><span class="line">&#123;</span><br><span class="line">    $this-&gt;terminateMiddleware($request, $response);</span><br><span class="line">    $this-&gt;app-&gt;terminate();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 终止中间件</span><br><span class="line">protected function terminateMiddleware($request, $response)</span><br><span class="line">&#123;</span><br><span class="line">    $middlewares = $this-&gt;app-&gt;shouldSkipMiddleware() ? [] : array_merge(</span><br><span class="line">        $this-&gt;gatherRouteMiddleware($request),</span><br><span class="line">        $this-&gt;middleware</span><br><span class="line">    );</span><br><span class="line">    foreach ($middlewares as $middleware) &#123;</span><br><span class="line">        if (! is_string($middleware)) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        list($name, $parameters) = $this-&gt;parseMiddleware($middleware);</span><br><span class="line">        $instance = $this-&gt;app-&gt;make($name);</span><br><span class="line">        if (method_exists($instance, &apos;terminate&apos;)) &#123;</span><br><span class="line">            $instance-&gt;terminate($request, $response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上便是 Laravel 的请求生命周期的始末。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>在 「创建 Laravel 应用实例」时不仅会注册项目基础服务、注册项目服务提供者别名、注册目录路径等在内的一系列注册工作；还会绑定 HTTP 内核及 Console 内核到 <strong>APP 容器</strong>， 同时在 HTTP 内核里配置中间件和引导程序。</p>
<p>进入 「接收请求并响应」里，会依据运行环境从 <strong>APP 容器</strong> 解析出 HTTP 内核或 Console 内核。如果是 HTTP 内核，还将把「中间件」及「引导程序」注册到 <strong>APP 容器</strong>。</p>
<p>所有初始化工作完成后便进入「处理 HTTP 请求」阶段。</p>
<p>一个 Http 请求实例会被注册到 <strong>APP 容器</strong>，通过启动「引导程序」来设置环境变量、加载配置文件等等系统环境配置；</p>
<p>随后请求被分发到匹配的路由，在路由中执行「中间件」以过滤不满足校验规则的请求，只有通过「中间件」处理的请求才最终处理实际的控制器或匿名函数生成响应结果。</p>
<p>最后发送响应给用户，清理项目中的中间件，完成一个 「请求」 - 「响应」 的生命周期，之后我们的 Web 服务器将等待下一轮用户请求。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>感谢下列优秀的 Laravel 研究资料：</p>
<ul>
<li><a href="http://blog.mallow-tech.com/2016/06/request-life-cycle-of-laravel/" target="_blank" rel="noopener">http://blog.mallow-tech.com/2016/06/request-life-cycle-of-laravel/</a></li>
<li><a href="http://laravel-recipes.com/recipes/52/understanding-the-request-lifecycle" target="_blank" rel="noopener">http://laravel-recipes.com/recipes/52/understanding-the-request-lifecycle</a></li>
<li><a href="http://www.cnblogs.com/sweng/p/6391542.html" target="_blank" rel="noopener">http://www.cnblogs.com/sweng/p/6391542.html</a></li>
<li><a href="https://www.dyike.com/2017/04/22/laravel-request-life-cycle/" target="_blank" rel="noopener">https://www.dyike.com/2017/04/22/laravel-request-life-cycle/</a></li>
<li><a href="http://www.cnblogs.com/wxw16/p/6218742.html" target="_blank" rel="noopener">http://www.cnblogs.com/wxw16/p/6218742.html</a></li>
<li><a href="http://www.php.cn/php-weizijiaocheng-386805.html" target="_blank" rel="noopener">http://www.php.cn/php-weizijiaocheng-386805.html</a></li>
<li><a href="https://segmentfault.com/a/1190000009369566" target="_blank" rel="noopener">https://segmentfault.com/a/1190000009369566</a></li>
<li><a href="https://segmentfault.com/a/1190000006946685" target="_blank" rel="noopener">https://segmentfault.com/a/1190000006946685</a></li>
<li><a href="https://blog.csdn.net/cDonDon/article/details/51694120" target="_blank" rel="noopener">https://blog.csdn.net/cDonDon/article/details/51694120</a></li>
<li><a href="https://segmentfault.com/a/1190000006832393" target="_blank" rel="noopener">https://segmentfault.com/a/1190000006832393</a></li>
</ul>

        </section>
    </article>
    
        
  </div>
  <aside>
    
    <div class="toc-container">
        <h1>目录</h1>
        <div class="content">
            <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#摘要"><span class="toc-number">1.</span> <span class="toc-text">摘要</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生命周期之始末"><span class="toc-number">2.</span> <span class="toc-text">生命周期之始末</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#加载项目依赖"><span class="toc-number">2.1.</span> <span class="toc-text">加载项目依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#创建-Laravel-应用实例"><span class="toc-number">2.2.</span> <span class="toc-text">创建 Laravel 应用实例</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#创建应用实例"><span class="toc-number">2.2.1.</span> <span class="toc-text">创建应用实例</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#内核绑定"><span class="toc-number">2.2.2.</span> <span class="toc-text">内核绑定</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#注册异常处理"><span class="toc-number">2.2.3.</span> <span class="toc-text">注册异常处理</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#本节小结"><span class="toc-number">2.2.4.</span> <span class="toc-text">本节小结</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#接收请求并响应"><span class="toc-number">2.3.</span> <span class="toc-text">接收请求并响应</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#解析内核实例"><span class="toc-number">2.3.1.</span> <span class="toc-text">解析内核实例</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#处理-HTTP-请求"><span class="toc-number">2.3.2.</span> <span class="toc-text">处理 HTTP 请求</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#处理请求"><span class="toc-number">2.3.3.</span> <span class="toc-text">#处理请求</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#启动「引导程序」"><span class="toc-number">2.3.4.</span> <span class="toc-text">#启动「引导程序」</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#发送响应"><span class="toc-number">2.4.</span> <span class="toc-text">发送响应</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#终止程序"><span class="toc-number">2.5.</span> <span class="toc-text">终止程序</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#总结"><span class="toc-number">3.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number"></span> <span class="toc-text">参考资料</span></a>
        </div>
    </div>
    
  </aside>
</main>



  
<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="/lib/in-view.min.js"></script>
<script src="/lib/lodash.min.js"></script>
<script>
  var isDown = true
  var oldY = 0
  inView.offset(50)

  document.body.addEventListener('touchstart', function(){});
  
  window.addEventListener('scroll', _.throttle(e => {
    var currentY = window.scrollY
    if((oldY - currentY) < 0) {
      isDown = true
    } else {
      isDown = false
    }
    oldY = currentY
  }, 250))

  $("article img").each(function() {
      var strA = "<a data-fancybox='gallery' href='" + this.src + "'></a>";
      $(this).wrapAll(strA);
  });

  $('.toc-link').each(function() {
      var href = $(this).attr("href");
      
      inView(href).on('exit', () => {
        if (isDown) {
          handleActive(href)
        }
      })

      inView(href).on('enter', () => {
        if (!isDown) {
          handleActive(href)
        }
      })

      this.onclick = function(e) {
        var pos = $(href).offset().top - 10;
        $("html,body").animate({scrollTop: pos}, 300);
        setTimeout(() => {
          handleActive(href)
        }, 350)
        return false
      }
  })

  function handleActive(href) {
    document.querySelectorAll('.toc-link').forEach(elm => {
      elm.classList.remove('active')
    })
    document.querySelector(".toc [href='"+ href +"']").classList.add('active')
  }
</script>
<script src="/lib/jquery.fancybox.min.js"></script>


</body>
</html>
